"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const os_1 = require("os");
const path_1 = require("path");
const child_process_1 = require("child_process");
class Tags {
    constructor() {
        this.inProgress = false;
        this.disposables = new atom_1.CompositeDisposable();
        this.tags = new Map();
        this.paths = atom.project.getPaths();
        this.filesChanged = (evts) => {
            for (const evt of evts) {
                if (!evt.path.endsWith('.hs') && !evt.path.endsWith('.lhs'))
                    continue;
                switch (evt.action) {
                    case 'created':
                        this.update(evt.path);
                        break;
                    case 'modified':
                        this.update(evt.path);
                        break;
                    case 'deleted':
                        this.tags.delete(evt.path);
                        break;
                    case 'renamed':
                        this.tags.delete(evt.oldPath);
                        this.update(evt.path);
                        break;
                }
            }
        };
        this.pathsChanged = (paths) => {
            const removedPaths = this.paths.filter((p) => !paths.includes(p));
            const addedPaths = paths.filter((p) => !this.paths.includes(p));
            if (removedPaths.length > 0) {
                Array.from(this.tags.keys())
                    .filter((f) => removedPaths.some((p) => f.startsWith(p + path_1.sep)))
                    .forEach((k) => this.tags.delete(k));
            }
            for (const path of addedPaths) {
                this.update(path);
            }
            this.paths = paths;
        };
        this.disposables.add(atom.project.onDidChangeFiles(this.filesChanged));
        this.disposables.add(atom.project.onDidChangePaths(this.pathsChanged));
        for (const path of this.paths) {
            this.update(path);
        }
    }
    destroy() {
        this.disposables.dispose();
        this.tags.clear();
    }
    update(path) {
        this.inProgress = true;
        let fn = false;
        let curfile = new Map();
        let cmd = atom.config.get('ide-haskell-hasktags.hasktagsPath');
        const env = Object.create(process.env);
        const args = [];
        if (cmd === 'hasktags.js') {
            env.ELECTRON_RUN_AS_NODE = 1;
            env.ELECTRON_NO_ATTACH_CONSOLE = 1;
            cmd = process.execPath;
            args.push('--no-deprecation');
            args.push(require.resolve('@atom-haskell/hasktags-js'));
        }
        args.push('-eRo-');
        if (atom.config.get('ide-haskell-hasktags.ignoreCloseImplementation')) {
            args.push('--ignore-close-implementation');
        }
        args.push(path);
        child_process_1.execFile(cmd, args, { env, encoding: 'utf8', maxBuffer: Infinity }, (error, data, stderr) => {
            try {
                if (error) {
                    switch (stderr) {
                        case '<stdout>: hFlush: illegal operation (handle is closed)':
                            break;
                        default:
                            console.warn('hasktags stderr', stderr);
                            atom.notifications.addError('Failed to run hasktags', {
                                detail: error.message,
                                stack: error.stack,
                                dismissable: true,
                            });
                            return;
                    }
                }
                const lines = data.split(os_1.EOL);
                for (const line of lines.slice(0, -1)) {
                    switch (true) {
                        case line === '\x0c':
                            fn = true;
                            break;
                        case fn:
                            fn = false;
                            const res = /^(.*),\d+$/.exec(line);
                            if (res === null)
                                continue;
                            const [, src] = res;
                            curfile = new Map();
                            this.tags.set(src, curfile);
                            break;
                        default:
                            const rxr = /^(.*)\x7f(.*)\x01(\d+),(\d+)$/.exec(line);
                            if (rxr === null)
                                continue;
                            const [, context, tagName, lineNo] = rxr;
                            let obj = curfile.get(tagName);
                            if (obj === undefined) {
                                obj = [];
                                curfile.set(tagName, obj);
                            }
                            obj.push({ context, line: parseInt(lineNo, 10) });
                    }
                }
            }
            finally {
                this.inProgress = false;
            }
        });
    }
    listTags(uri) {
        const res = [];
        if (!uri) {
            this.tags.forEach((tagMap, uri) => tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line }))));
        }
        else {
            const tagMap = this.tags.get(uri);
            if (tagMap !== undefined) {
                tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line })));
            }
        }
        return res;
    }
    findTag(tag) {
        const res = [];
        this.tags.forEach((tagMap, uri) => {
            const lines = tagMap.get(tag);
            if (lines === undefined)
                return;
            lines.forEach(({ context, line }) => {
                res.push({ tag, uri, context, line });
            });
        });
        return res;
    }
}
exports.Tags = Tags;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90YWdzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQWlFO0FBQ2pFLDJCQUF3QjtBQUN4QiwrQkFBMEI7QUFDMUIsaURBQXdDO0FBVXhDO0lBS0U7UUFKTyxlQUFVLEdBQVksS0FBSyxDQUFBO1FBQzFCLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQ3ZDLFNBQUksR0FBUSxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ3JCLFVBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBc0gvQixpQkFBWSxHQUFHLENBQUMsSUFBMkIsRUFBRSxFQUFFO1lBQ3JELEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFBQyxRQUFRLENBQUE7Z0JBQ3JFLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNuQixLQUFLLFNBQVM7d0JBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7d0JBQ3JCLEtBQUssQ0FBQTtvQkFDUCxLQUFLLFVBQVU7d0JBQ2IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7d0JBQ3JCLEtBQUssQ0FBQTtvQkFDUCxLQUFLLFNBQVM7d0JBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO3dCQUMxQixLQUFLLENBQUE7b0JBQ1AsS0FBSyxTQUFTO3dCQUVaLElBQUksQ0FBQyxJQUFJLENB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SSxFQUFFLEVBQUUsRUFBRSxDQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FDdEMsQ0FDRixDQUFBO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsR0FBRyxDQUFBO0lBQ1osQ0FBQztJQUVNLE9BQU8sQ0FBQyxHQUFXO1FBQ3hCLE1BQU0sR0FBRyxHQUFhLEVBQUUsQ0FBQTtRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNoQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzdCLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7Z0JBQUMsTUFBTSxDQUFBO1lBQy9CLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO2dCQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUN2QyxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLEdBQUcsQ0FBQTtJQUNaLENBQUM7Q0FxQ0Y7QUE3SkQsb0JBNkpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRmlsZXN5c3RlbUNoYW5nZUV2ZW50IH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJ1xuaW1wb3J0IHsgc2VwIH0gZnJvbSAncGF0aCdcbmltcG9ydCB7IGV4ZWNGaWxlIH0gZnJvbSAnY2hpbGRfcHJvY2VzcydcblxuaW50ZXJmYWNlIExpbmVSZWMge1xuICBjb250ZXh0OiBzdHJpbmdcbiAgbGluZTogbnVtYmVyXG59XG5cbnR5cGUgRmlsZVJlYyA9IE1hcDxzdHJpbmcsIExpbmVSZWNbXT5cbnR5cGUgUmVjID0gTWFwPHN0cmluZywgRmlsZVJlYz5cblxuZXhwb3J0IGNsYXNzIFRhZ3Mge1xuICBwdWJsaWMgaW5Qcm9ncmVzczogYm9vbGVhbiA9IGZhbHNlXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgdGFnczogUmVjID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgcGF0aHMgPSBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLnByb2plY3Qub25EaWRDaGFuZ2VGaWxlcyh0aGlzLmZpbGVzQ2hhbmdlZCkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHModGhpcy5wYXRoc0NoYW5nZWQpKVxuICAgIGZvciAoY29uc3QgcGF0aCBvZiB0aGlzLnBhdGhzKSB7XG4gICAgICB0aGlzLnVwZGF0ZShwYXRoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdGhpcy50YWdzLmNsZWFyKClcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUocGF0aDogc3RyaW5nKSB7XG4gICAgdGhpcy5pblByb2dyZXNzID0gdHJ1ZVxuICAgIGxldCBmbjogYm9vbGVhbiA9IGZhbHNlXG4gICAgbGV0IGN1cmZpbGU6IE1hcDxzdHJpbmcsIExpbmVSZWNbXT4gPSBuZXcgTWFwKClcbiAgICBsZXQgY21kOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBhdG9tLmNvbmZpZy5nZXQoXG4gICAgICAnaWRlLWhhc2tlbGwtaGFza3RhZ3MuaGFza3RhZ3NQYXRoJyxcbiAgICApXG4gICAgY29uc3QgZW52ID0gT2JqZWN0LmNyZWF0ZShwcm9jZXNzLmVudilcbiAgICBjb25zdCBhcmdzID0gW11cbiAgICBpZiAoY21kID09PSAnaGFza3RhZ3MuanMnKSB7XG4gICAgICBlbnYuRUxFQ1RST05fUlVOX0FTX05PREUgPSAxXG4gICAgICBlbnYuRUxFQ1RST05fTk9fQVRUQUNIX0NPTlNPTEUgPSAxXG4gICAgICBjbWQgPSBwcm9jZXNzLmV4ZWNQYXRoXG4gICAgICBhcmdzLnB1c2goJy0tbm8tZGVwcmVjYXRpb24nKVxuICAgICAgYXJncy5wdXNoKHJlcXVpcmUucmVzb2x2ZSgnQGF0b20taGFza2VsbC9oYXNrdGFncy1qcycpKVxuICAgIH1cbiAgICBhcmdzLnB1c2goJy1lUm8tJylcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1oYXNrdGFncy5pZ25vcmVDbG9zZUltcGxlbWVudGF0aW9uJykpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1pZ25vcmUtY2xvc2UtaW1wbGVtZW50YXRpb24nKVxuICAgIH1cbiAgICBhcmdzLnB1c2gocGF0aClcbiAgICBleGVjRmlsZShjbWQsIGFyZ3MsIHsgZW52LCBlbmNvZGluZzogJ3V0ZjgnLCBtYXhCdWZmZXI6IEluZmluaXR5IH0sIChlcnJvciwgZGF0YSwgc3RkZXJyKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICBzd2l0Y2ggKHN0ZGVycikge1xuICAgICAgICAgICAgY2FzZSAnPHN0ZG91dD46IGhGbHVzaDogaWxsZWdhbCBvcGVyYXRpb24gKGhhbmRsZSBpcyBjbG9zZWQpJzpcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIGNvbnNvbGUud2FybignaGFza3RhZ3Mgc3RkZXJyJywgc3RkZXJyKVxuICAgICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoJ0ZhaWxlZCB0byBydW4gaGFza3RhZ3MnLCB7XG4gICAgICAgICAgICAgICAgZGV0YWlsOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGxpbmVzID0gZGF0YS5zcGxpdChFT0wpXG4gICAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcy5zbGljZSgwLCAtMSkpIHtcbiAgICAgICAgICBzd2l0Y2ggKHRydWUpIHtcbiAgICAgICAgICAgIGNhc2UgbGluZSA9PT0gJ1xceDBjJzpcbiAgICAgICAgICAgICAgZm4gPSB0cnVlXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBjYXNlIGZuOlxuICAgICAgICAgICAgICBmbiA9IGZhbHNlXG4gICAgICAgICAgICAgIGNvbnN0IHJlcyA9IC9eKC4qKSxcXGQrJC8uZXhlYyhsaW5lKVxuICAgICAgICAgICAgICBpZiAocmVzID09PSBudWxsKSBjb250aW51ZVxuICAgICAgICAgICAgICBjb25zdCBbLCBzcmNdID0gcmVzXG4gICAgICAgICAgICAgIGN1cmZpbGUgPSBuZXcgTWFwKClcbiAgICAgICAgICAgICAgdGhpcy50YWdzLnNldChzcmMsIGN1cmZpbGUpXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICBjb25zdCByeHIgPSAvXiguKilcXHg3ZiguKilcXHgwMShcXGQrKSwoXFxkKykkLy5leGVjKGxpbmUpXG4gICAgICAgICAgICAgIGlmIChyeHIgPT09IG51bGwpIGNvbnRpbnVlXG4gICAgICAgICAgICAgIGNvbnN0IFssIGNvbnRleHQsIHRhZ05hbWUsIGxpbmVOb10gPSByeHJcbiAgICAgICAgICAgICAgbGV0IG9iaiA9IGN1cmZpbGUuZ2V0KHRhZ05hbWUpXG4gICAgICAgICAgICAgIGlmIChvYmogPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIG9iaiA9IFtdXG4gICAgICAgICAgICAgICAgY3VyZmlsZS5zZXQodGFnTmFtZSwgb2JqKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIG9iai5wdXNoKHsgY29udGV4dCwgbGluZTogcGFyc2VJbnQobGluZU5vLCAxMCkgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIHRoaXMuaW5Qcm9ncmVzcyA9IGZhbHNlXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBsaXN0VGFncyh1cmk/OiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXM6IFN5bVJlY1tdID0gW11cbiAgICBpZiAoIXVyaSkge1xuICAgICAgdGhpcy50YWdzLmZvckVhY2goKHRhZ01hcCwgdXJpKSA9PlxuICAgICAgICB0YWdNYXAuZm9yRWFjaCgobGluZXMsIHRhZykgPT5cbiAgICAgICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT5cbiAgICAgICAgICAgIHJlcy5wdXNoKHsgdGFnLCB1cmksIGNvbnRleHQsIGxpbmUgfSksXG4gICAgICAgICAgKSxcbiAgICAgICAgKSxcbiAgICAgIClcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdGFnTWFwID0gdGhpcy50YWdzLmdldCh1cmkpXG4gICAgICBpZiAodGFnTWFwICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGFnTWFwLmZvckVhY2goKGxpbmVzLCB0YWcpID0+XG4gICAgICAgICAgbGluZXMuZm9yRWFjaCgoeyBjb250ZXh0LCBsaW5lIH0pID0+XG4gICAgICAgICAgICByZXMucHVzaCh7IHRhZywgdXJpLCBjb250ZXh0LCBsaW5lIH0pLFxuICAgICAgICAgICksXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgcHVibGljIGZpbmRUYWcodGFnOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXM6IFN5bVJlY1tdID0gW11cbiAgICB0aGlzLnRhZ3MuZm9yRWFjaCgodGFnTWFwLCB1cmkpID0+IHtcbiAgICAgIGNvbnN0IGxpbmVzID0gdGFnTWFwLmdldCh0YWcpXG4gICAgICBpZiAobGluZXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuXG4gICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT4ge1xuICAgICAgICByZXMucHVzaCh7IHRhZywgdXJpLCBjb250ZXh0LCBsaW5lIH0pXG4gICAgICB9KVxuICAgIH0pXG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgcHJpdmF0ZSBmaWxlc0NoYW5nZWQgPSAoZXZ0czogRmlsZXN5c3RlbUNoYW5nZUV2ZW50KSA9PiB7XG4gICAgZm9yIChjb25zdCBldnQgb2YgZXZ0cykge1xuICAgICAgaWYgKCFldnQucGF0aC5lbmRzV2l0aCgnLmhzJykgJiYgIWV2dC5wYXRoLmVuZHNXaXRoKCcubGhzJykpIGNvbnRpbnVlXG4gICAgICBzd2l0Y2ggKGV2dC5hY3Rpb24pIHtcbiAgICAgICAgY2FzZSAnY3JlYXRlZCc6XG4gICAgICAgICAgdGhpcy51cGRhdGUoZXZ0LnBhdGgpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnbW9kaWZpZWQnOlxuICAgICAgICAgIHRoaXMudXBkYXRlKGV2dC5wYXRoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ2RlbGV0ZWQnOlxuICAgICAgICAgIHRoaXMudGFncy5kZWxldGUoZXZ0LnBhdGgpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAncmVuYW1lZCc6XG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICB0aGlzLnRhZ3MuZGVsZXRlKGV2dC5vbGRQYXRoISlcbiAgICAgICAgICB0aGlzLnVwZGF0ZShldnQucGF0aClcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGF0aHNDaGFuZ2VkID0gKHBhdGhzOiBzdHJpbmdbXSkgPT4ge1xuICAgIGNvbnN0IHJlbW92ZWRQYXRocyA9IHRoaXMucGF0aHMuZmlsdGVyKChwKSA9PiAhcGF0aHMuaW5jbHVkZXMocCkpXG4gICAgY29uc3QgYWRkZWRQYXRocyA9IHBhdGhzLmZpbHRlcigocCkgPT4gIXRoaXMucGF0aHMuaW5jbHVkZXMocCkpXG4gICAgaWYgKHJlbW92ZWRQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBBcnJheS5mcm9tKHRoaXMudGFncy5rZXlzKCkpXG4gICAgICAgIC5maWx0ZXIoKGYpID0+IHJlbW92ZWRQYXRocy5zb21lKChwKSA9PiBmLnN0YXJ0c1dpdGgocCArIHNlcCkpKVxuICAgICAgICAuZm9yRWFjaCgoaykgPT4gdGhpcy50YWdzLmRlbGV0ZShrKSlcbiAgICB9XG4gICAgZm9yIChjb25zdCBwYXRoIG9mIGFkZGVkUGF0aHMpIHtcbiAgICAgIHRoaXMudXBkYXRlKHBhdGgpXG4gICAgfVxuICAgIHRoaXMucGF0aHMgPSBwYXRoc1xuICB9XG59XG4iXX0=