"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const os_1 = require("os");
const path_1 = require("path");
class Tags {
    constructor() {
        this.inProgress = false;
        this.disposables = new atom_1.CompositeDisposable();
        this.tags = new Map();
        this.filesChanged = (evts) => {
            for (const evt of evts) {
                if (!evt.path.endsWith('.hs') && !evt.path.endsWith('.lhs'))
                    continue;
                switch (evt.action) {
                    case 'created':
                        this.update(evt.path);
                        break;
                    case 'modified':
                        this.update(evt.path);
                        break;
                    case 'deleted':
                        this.tags.delete(evt.path);
                        break;
                    case 'renamed':
                        this.tags.delete(evt.oldPath);
                        this.update(evt.path);
                        break;
                }
            }
        };
        this.disposables.add(atom.project.onDidChangeFiles(this.filesChanged));
        for (const path of atom.project.getPaths()) {
            this.update(path);
        }
    }
    destroy() {
        this.disposables.dispose();
        this.tags.clear();
    }
    update(path) {
        this.inProgress = true;
        let fn = false;
        let curfile = new Map();
        let cmd = atom.config.get('ide-haskell-hasktags.hasktagsPath');
        if (!cmd)
            return;
        let BP;
        if (cmd === 'hasktags.js') {
            cmd = `${__dirname}${path_1.sep}..${path_1.sep}bin${path_1.sep}hasktags.js`;
            BP = atom_1.BufferedNodeProcess;
        }
        else {
            BP = atom_1.BufferedProcess;
        }
        const hasktagsArgs = ['-eRo-'];
        if (atom.config.get('ide-haskell-hasktags.ignoreCloseImplementation')) {
            hasktagsArgs.push('--ignore-close-implementation');
        }
        hasktagsArgs.push(path);
        new BP({
            command: cmd,
            args: hasktagsArgs,
            stdout: (data) => {
                const lines = data.split(os_1.EOL);
                for (const line of lines.slice(0, -1)) {
                    switch (true) {
                        case line === '\x0c':
                            fn = true;
                            break;
                        case fn:
                            fn = false;
                            const res = /^(.*),\d+$/.exec(line);
                            if (res === null)
                                continue;
                            const [, src] = res;
                            curfile = new Map();
                            this.tags.set(src, curfile);
                            break;
                        default:
                            const rxr = /^(.*)\x7f(.*)\x01(\d+),(\d+)$/.exec(line);
                            if (rxr === null)
                                continue;
                            const [, context, tagName, lineNo] = rxr;
                            let obj = curfile.get(tagName);
                            if (obj === undefined) {
                                obj = [];
                                curfile.set(tagName, obj);
                            }
                            obj.push({ context, line: parseInt(lineNo, 10) });
                    }
                }
            },
            exit: () => { this.inProgress = false; },
        });
    }
    listTags(uri) {
        const res = [];
        if (!uri) {
            this.tags.forEach((tagMap, uri) => tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line }))));
        }
        else {
            const tagMap = this.tags.get(uri);
            if (tagMap !== undefined) {
                tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line })));
            }
        }
        return res;
    }
    findTag(tag) {
        const res = [];
        this.tags.forEach((tagMap, uri) => {
            const lines = tagMap.get(tag);
            if (lines === undefined)
                return;
            lines.forEach(({ context, line }) => {
                res.push({ tag, uri, context, line });
            });
        });
        return res;
    }
}
exports.Tags = Tags;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90YWdzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXVHO0FBQ3ZHLDJCQUF3QjtBQUN4QiwrQkFBMEI7QUFVMUI7SUFJRTtRQUhPLGVBQVUsR0FBWSxLQUFLLENBQUE7UUFDMUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDdkMsU0FBSSxHQUFRLElBQUksR0FBRyxFQUFFLENBQUE7UUFxR3JCLGlCQUFZLEdBQUcsQ0FBQyxJQUEyQixFQUFFLEVBQUU7WUFDckQsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdkIsRUFBRSxDQUFDLENBQUMsQ0FBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUFDLFFBQVEsQ0FBQTtnQkFDdkUsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ25CLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO29CQUNQLEtBQUssVUFBVTt3QkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO29CQUNQLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7d0JBQzFCLEtBQUssQ0FBQTtvQkFDUCxLQUFLLFNBQVM7d0JBRVosSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQVEsQ0FBQyxDQUFBO3dCQUM5QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO2dCQUNULENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFBO1FBdkhDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUE7UUFDdEUsR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNuQixDQUFDO0lBQ0gsQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxJQUFZO1FBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFBO1FBQ3RCLElBQUksRUFBRSxHQUFZLEtBQUssQ0FBQTtRQUN2QixJQUFJLE9BQU8sR0FBMkIsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUMvQyxJQUFJLEdBQUcsR0FBdUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLENBQUMsQ0FBQTtRQUNsRixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUNoQixJQUFJLEVBQUUsQ0FBQTtRQUNOLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQzFCLEdBQUcsR0FBRyxHQUFHLFNBQVMsR0FBRyxVQUFHLEtBQUssVUFBRyxNQUFNLFVBQUcsYUFBYSxDQUFBO1lBQ3RELEVBQUUsR0FBRywwQkFBbUIsQ0FBQTtRQUMxQixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixFQUFFLEdBQUcsc0JBQWUsQ0FBQTtRQUN0QixDQUFDO1FBQ0QsTUFBTSxZQUFZLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUM5QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RSxZQUFZLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLENBQUE7UUFDcEQsQ0FBQztRQUNELFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFdkIsSUFBSSxFQUFFLENBQUM7WUFDTCxPQUFPLEVBQUUsR0FBRztZQUNaLElBQUksRUFBRSxZQUFZO1lBQ2xCLE1BQU0sRUFBRSxDQUFDLElBQVksRUFBRSxFQUFFO2dCQUN2QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQUcsQ0FBQyxDQUFBO2dCQUM3QixHQUFHLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdEMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDYixLQUFLLElBQUksS0FBSyxNQUFNOzRCQUNsQixFQUFFLEdBQUcsSUFBSSxDQUFBOzRCQUNULEtBQUssQ0FBQTt3QkFDUCxLQUFLLEVBQUU7NEJBQ0wsRUFBRSxHQUFHLEtBQUssQ0FBQTs0QkFDVixNQUFNLEdBQUcsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBOzRCQUNuQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDO2dDQUFDLFFBQVEsQ0FBQTs0QkFDMUIsTUFBTSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFBOzRCQUNuQixPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTs0QkFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFBOzRCQUMzQixLQUFLLENBQUE7d0JBQ1A7NEJBQ0UsTUFBTSxHQUFHLEdBQUcsK0JBQStCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBOzRCQUN0RCxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDO2dDQUFDLFFBQVEsQ0FBQTs0QkFDMUIsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUE7NEJBQ3hDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7NEJBQzlCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dDQUN0QixHQUFHLEdBQUcsRUFBRSxDQUFBO2dDQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFBOzRCQUMzQixDQUFDOzRCQUNELEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO29CQUNyRCxDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDO1lBQ0QsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFBLENBQUMsQ0FBQztTQUN4QyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRU0sUUFBUSxDQUFDLEdBQVk7UUFDMUIsTUFBTSxHQUFHLEdBQWEsRUFBRSxDQUFBO1FBQ3hCLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNULElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUNmLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQ2QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUM1QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FDNUMsQ0FBQyxDQUFDLENBQUE7UUFDTCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNqQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUM1QixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FDdEMsQ0FDRixDQUFBO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsR0FBRyxDQUFBO0lBQ1osQ0FBQztJQUVNLE9BQU8sQ0FBQyxHQUFXO1FBQ3hCLE1BQU0sR0FBRyxHQUFhLEVBQUUsQ0FBQTtRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNoQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzdCLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7Z0JBQUMsTUFBTSxDQUFBO1lBQy9CLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO2dCQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUN2QyxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLEdBQUcsQ0FBQTtJQUNaLENBQUM7Q0F1QkY7QUE3SEQsb0JBNkhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgQnVmZmVyZWRQcm9jZXNzLCBCdWZmZXJlZE5vZGVQcm9jZXNzLCBGaWxlc3lzdGVtQ2hhbmdlRXZlbnQgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5pbXBvcnQgeyBzZXAgfSBmcm9tICdwYXRoJ1xuXG5pbnRlcmZhY2UgTGluZVJlYyB7XG4gIGNvbnRleHQ6IHN0cmluZ1xuICBsaW5lOiBudW1iZXJcbn1cblxudHlwZSBGaWxlUmVjID0gTWFwPHN0cmluZywgTGluZVJlY1tdPlxudHlwZSBSZWMgPSBNYXA8c3RyaW5nLCBGaWxlUmVjPlxuXG5leHBvcnQgY2xhc3MgVGFncyB7XG4gIHB1YmxpYyBpblByb2dyZXNzOiBib29sZWFuID0gZmFsc2VcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSB0YWdzOiBSZWMgPSBuZXcgTWFwKClcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXModGhpcy5maWxlc0NoYW5nZWQpKVxuICAgIGZvciAoY29uc3QgcGF0aCBvZiBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKSkge1xuICAgICAgdGhpcy51cGRhdGUocGF0aClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMudGFncy5jbGVhcigpXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKHBhdGg6IHN0cmluZykge1xuICAgIHRoaXMuaW5Qcm9ncmVzcyA9IHRydWVcbiAgICBsZXQgZm46IGJvb2xlYW4gPSBmYWxzZVxuICAgIGxldCBjdXJmaWxlOiBNYXA8c3RyaW5nLCBMaW5lUmVjW10+ID0gbmV3IE1hcCgpXG4gICAgbGV0IGNtZDogc3RyaW5nIHwgdW5kZWZpbmVkID0gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1oYXNrdGFncy5oYXNrdGFnc1BhdGgnKVxuICAgIGlmICghY21kKSByZXR1cm5cbiAgICBsZXQgQlBcbiAgICBpZiAoY21kID09PSAnaGFza3RhZ3MuanMnKSB7XG4gICAgICBjbWQgPSBgJHtfX2Rpcm5hbWV9JHtzZXB9Li4ke3NlcH1iaW4ke3NlcH1oYXNrdGFncy5qc2BcbiAgICAgIEJQID0gQnVmZmVyZWROb2RlUHJvY2Vzc1xuICAgIH0gZWxzZSB7XG4gICAgICBCUCA9IEJ1ZmZlcmVkUHJvY2Vzc1xuICAgIH1cbiAgICBjb25zdCBoYXNrdGFnc0FyZ3MgPSBbJy1lUm8tJ11cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1oYXNrdGFncy5pZ25vcmVDbG9zZUltcGxlbWVudGF0aW9uJykpIHtcbiAgICAgIGhhc2t0YWdzQXJncy5wdXNoKCctLWlnbm9yZS1jbG9zZS1pbXBsZW1lbnRhdGlvbicpXG4gICAgfVxuICAgIGhhc2t0YWdzQXJncy5wdXNoKHBhdGgpXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVudXNlZC1leHByZXNzaW9uXG4gICAgbmV3IEJQKHtcbiAgICAgIGNvbW1hbmQ6IGNtZCxcbiAgICAgIGFyZ3M6IGhhc2t0YWdzQXJncyxcbiAgICAgIHN0ZG91dDogKGRhdGE6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBsaW5lcyA9IGRhdGEuc3BsaXQoRU9MKVxuICAgICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMuc2xpY2UoMCwgLTEpKSB7XG4gICAgICAgICAgc3dpdGNoICh0cnVlKSB7XG4gICAgICAgICAgICBjYXNlIGxpbmUgPT09ICdcXHgwYyc6XG4gICAgICAgICAgICAgIGZuID0gdHJ1ZVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSBmbjpcbiAgICAgICAgICAgICAgZm4gPSBmYWxzZVxuICAgICAgICAgICAgICBjb25zdCByZXMgPSAvXiguKiksXFxkKyQvLmV4ZWMobGluZSlcbiAgICAgICAgICAgICAgaWYgKHJlcyA9PT0gbnVsbCkgY29udGludWVcbiAgICAgICAgICAgICAgY29uc3QgWywgc3JjXSA9IHJlc1xuICAgICAgICAgICAgICBjdXJmaWxlID0gbmV3IE1hcCgpXG4gICAgICAgICAgICAgIHRoaXMudGFncy5zZXQoc3JjLCBjdXJmaWxlKVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgY29uc3QgcnhyID0gL14oLiopXFx4N2YoLiopXFx4MDEoXFxkKyksKFxcZCspJC8uZXhlYyhsaW5lKVxuICAgICAgICAgICAgICBpZiAocnhyID09PSBudWxsKSBjb250aW51ZVxuICAgICAgICAgICAgICBjb25zdCBbLCBjb250ZXh0LCB0YWdOYW1lLCBsaW5lTm9dID0gcnhyXG4gICAgICAgICAgICAgIGxldCBvYmogPSBjdXJmaWxlLmdldCh0YWdOYW1lKVxuICAgICAgICAgICAgICBpZiAob2JqID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBvYmogPSBbXVxuICAgICAgICAgICAgICAgIGN1cmZpbGUuc2V0KHRhZ05hbWUsIG9iailcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBvYmoucHVzaCh7IGNvbnRleHQsIGxpbmU6IHBhcnNlSW50KGxpbmVObywgMTApIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZXhpdDogKCkgPT4geyB0aGlzLmluUHJvZ3Jlc3MgPSBmYWxzZSB9LFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgbGlzdFRhZ3ModXJpPzogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzOiBTeW1SZWNbXSA9IFtdXG4gICAgaWYgKCF1cmkpIHtcbiAgICAgIHRoaXMudGFncy5mb3JFYWNoKFxuICAgICAgICAodGFnTWFwLCB1cmkpID0+XG4gICAgICAgICAgdGFnTWFwLmZvckVhY2goKGxpbmVzLCB0YWcpID0+XG4gICAgICAgICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT5cbiAgICAgICAgICAgICAgcmVzLnB1c2goeyB0YWcsIHVyaSwgY29udGV4dCwgbGluZSB9KSxcbiAgICAgICkpKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB0YWdNYXAgPSB0aGlzLnRhZ3MuZ2V0KHVyaSlcbiAgICAgIGlmICh0YWdNYXAgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0YWdNYXAuZm9yRWFjaCgobGluZXMsIHRhZykgPT5cbiAgICAgICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT5cbiAgICAgICAgICAgIHJlcy5wdXNoKHsgdGFnLCB1cmksIGNvbnRleHQsIGxpbmUgfSksXG4gICAgICAgICAgKSxcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwdWJsaWMgZmluZFRhZyh0YWc6IHN0cmluZykge1xuICAgIGNvbnN0IHJlczogU3ltUmVjW10gPSBbXVxuICAgIHRoaXMudGFncy5mb3JFYWNoKCh0YWdNYXAsIHVyaSkgPT4ge1xuICAgICAgY29uc3QgbGluZXMgPSB0YWdNYXAuZ2V0KHRhZylcbiAgICAgIGlmIChsaW5lcyA9PT0gdW5kZWZpbmVkKSByZXR1cm5cbiAgICAgIGxpbmVzLmZvckVhY2goKHsgY29udGV4dCwgbGluZSB9KSA9PiB7XG4gICAgICAgIHJlcy5wdXNoKHsgdGFnLCB1cmksIGNvbnRleHQsIGxpbmUgfSlcbiAgICAgIH0pXG4gICAgfSlcbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwcml2YXRlIGZpbGVzQ2hhbmdlZCA9IChldnRzOiBGaWxlc3lzdGVtQ2hhbmdlRXZlbnQpID0+IHtcbiAgICBmb3IgKGNvbnN0IGV2dCBvZiBldnRzKSB7XG4gICAgICBpZiAoISBldnQucGF0aC5lbmRzV2l0aCgnLmhzJykgJiYgISBldnQucGF0aC5lbmRzV2l0aCgnLmxocycpKSBjb250aW51ZVxuICAgICAgc3dpdGNoIChldnQuYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgJ2NyZWF0ZWQnOlxuICAgICAgICAgIHRoaXMudXBkYXRlKGV2dC5wYXRoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ21vZGlmaWVkJzpcbiAgICAgICAgICB0aGlzLnVwZGF0ZShldnQucGF0aClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdkZWxldGVkJzpcbiAgICAgICAgICB0aGlzLnRhZ3MuZGVsZXRlKGV2dC5wYXRoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ3JlbmFtZWQnOlxuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgICAgdGhpcy50YWdzLmRlbGV0ZShldnQub2xkUGF0aCEpXG4gICAgICAgICAgdGhpcy51cGRhdGUoZXZ0LnBhdGgpXG4gICAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==