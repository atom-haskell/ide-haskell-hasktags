"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const os_1 = require("os");
const path_1 = require("path");
class Tags {
    constructor() {
        this.inProgress = false;
        this.disposables = new atom_1.CompositeDisposable();
        this.tags = new Map();
        this.paths = atom.project.getPaths();
        this.filesChanged = (evts) => {
            for (const evt of evts) {
                if (!evt.path.endsWith('.hs') && !evt.path.endsWith('.lhs'))
                    continue;
                switch (evt.action) {
                    case 'created':
                        this.update(evt.path);
                        break;
                    case 'modified':
                        this.update(evt.path);
                        break;
                    case 'deleted':
                        this.tags.delete(evt.path);
                        break;
                    case 'renamed':
                        this.tags.delete(evt.oldPath);
                        this.update(evt.path);
                        break;
                }
            }
        };
        this.pathsChanged = (paths) => {
            const removedPaths = this.paths.filter(p => !paths.includes(p));
            const addedPaths = paths.filter(p => !this.paths.includes(p));
            console.error('pathsChanged', removedPaths, addedPaths);
            if (removedPaths.length > 0) {
                Array.from(this.tags.keys()).filter(f => removedPaths.some(p => f.startsWith(p + path_1.sep))).forEach(k => this.tags.delete(k));
            }
            for (const path of addedPaths) {
                this.update(path);
            }
            this.paths = paths;
        };
        this.disposables.add(atom.project.onDidChangeFiles(this.filesChanged));
        this.disposables.add(atom.project.onDidChangePaths(this.pathsChanged));
        for (const path of this.paths) {
            this.update(path);
        }
    }
    destroy() {
        this.disposables.dispose();
        this.tags.clear();
    }
    update(path) {
        this.inProgress = true;
        let fn = false;
        let curfile = new Map();
        let cmd = atom.config.get('ide-haskell-hasktags.hasktagsPath');
        if (!cmd)
            return;
        let BP;
        if (cmd === 'hasktags.js') {
            cmd = `${__dirname}${path_1.sep}..${path_1.sep}bin${path_1.sep}hasktags.js`;
            BP = atom_1.BufferedNodeProcess;
        }
        else {
            BP = atom_1.BufferedProcess;
        }
        const hasktagsArgs = ['-eRo-'];
        if (atom.config.get('ide-haskell-hasktags.ignoreCloseImplementation')) {
            hasktagsArgs.push('--ignore-close-implementation');
        }
        hasktagsArgs.push(path);
        new BP({
            command: cmd,
            args: hasktagsArgs,
            stdout: (data) => {
                const lines = data.split(os_1.EOL);
                for (const line of lines.slice(0, -1)) {
                    switch (true) {
                        case line === '\x0c':
                            fn = true;
                            break;
                        case fn:
                            fn = false;
                            const res = /^(.*),\d+$/.exec(line);
                            if (res === null)
                                continue;
                            const [, src] = res;
                            curfile = new Map();
                            this.tags.set(src, curfile);
                            break;
                        default:
                            const rxr = /^(.*)\x7f(.*)\x01(\d+),(\d+)$/.exec(line);
                            if (rxr === null)
                                continue;
                            const [, context, tagName, lineNo] = rxr;
                            let obj = curfile.get(tagName);
                            if (obj === undefined) {
                                obj = [];
                                curfile.set(tagName, obj);
                            }
                            obj.push({ context, line: parseInt(lineNo, 10) });
                    }
                }
            },
            exit: () => { this.inProgress = false; },
        });
    }
    listTags(uri) {
        const res = [];
        if (!uri) {
            this.tags.forEach((tagMap, uri) => tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line }))));
        }
        else {
            const tagMap = this.tags.get(uri);
            if (tagMap !== undefined) {
                tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line })));
            }
        }
        return res;
    }
    findTag(tag) {
        const res = [];
        this.tags.forEach((tagMap, uri) => {
            const lines = tagMap.get(tag);
            if (lines === undefined)
                return;
            lines.forEach(({ context, line }) => {
                res.push({ tag, uri, context, line });
            });
        });
        return res;
    }
}
exports.Tags = Tags;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90YWdzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXVHO0FBQ3ZHLDJCQUF3QjtBQUN4QiwrQkFBMEI7QUFVMUI7SUFLRTtRQUpPLGVBQVUsR0FBWSxLQUFLLENBQUE7UUFDMUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDdkMsU0FBSSxHQUFRLElBQUksR0FBRyxFQUFFLENBQUE7UUFDckIsVUFBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUE7UUFzRy9CLGlCQUFZLEdBQUcsQ0FBQyxJQUEyQixFQUFFLEVBQUU7WUFDckQsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdkIsRUFBRSxDQUFDLENBQUMsQ0FBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUFDLFFBQVEsQ0FBQTtnQkFDdkUsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ25CLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO29CQUNQLEtBQUssVUFBVTt3QkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO29CQUNQLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7d0JBQzFCLEtBQUssQ0FBQTtvQkFDUCxLQUFLLFNBQVM7d0JBRVosSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMs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RSxHQUFHLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1lBQ3ZDLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7UUFDRixNQUFNLENBQUMsR0FBRyxDQUFBO0lBQ1osQ0FBQztDQXNDRjtBQTlJRCxvQkE4SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBCdWZmZXJlZFByb2Nlc3MsIEJ1ZmZlcmVkTm9kZVByb2Nlc3MsIEZpbGVzeXN0ZW1DaGFuZ2VFdmVudCB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcbmltcG9ydCB7IHNlcCB9IGZyb20gJ3BhdGgnXG5cbmludGVyZmFjZSBMaW5lUmVjIHtcbiAgY29udGV4dDogc3RyaW5nXG4gIGxpbmU6IG51bWJlclxufVxuXG50eXBlIEZpbGVSZWMgPSBNYXA8c3RyaW5nLCBMaW5lUmVjW10+XG50eXBlIFJlYyA9IE1hcDxzdHJpbmcsIEZpbGVSZWM+XG5cbmV4cG9ydCBjbGFzcyBUYWdzIHtcbiAgcHVibGljIGluUHJvZ3Jlc3M6IGJvb2xlYW4gPSBmYWxzZVxuICBwcml2YXRlIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIHRhZ3M6IFJlYyA9IG5ldyBNYXAoKVxuICBwcml2YXRlIHBhdGhzID0gYXRvbS5wcm9qZWN0LmdldFBhdGhzKClcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXModGhpcy5maWxlc0NoYW5nZWQpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGF0b20ucHJvamVjdC5vbkRpZENoYW5nZVBhdGhzKHRoaXMucGF0aHNDaGFuZ2VkKSlcbiAgICBmb3IgKGNvbnN0IHBhdGggb2YgdGhpcy5wYXRocykge1xuICAgICAgdGhpcy51cGRhdGUocGF0aClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMudGFncy5jbGVhcigpXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKHBhdGg6IHN0cmluZykge1xuICAgIHRoaXMuaW5Qcm9ncmVzcyA9IHRydWVcbiAgICBsZXQgZm46IGJvb2xlYW4gPSBmYWxzZVxuICAgIGxldCBjdXJmaWxlOiBNYXA8c3RyaW5nLCBMaW5lUmVjW10+ID0gbmV3IE1hcCgpXG4gICAgbGV0IGNtZDogc3RyaW5nIHwgdW5kZWZpbmVkID0gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1oYXNrdGFncy5oYXNrdGFnc1BhdGgnKVxuICAgIGlmICghY21kKSByZXR1cm5cbiAgICBsZXQgQlBcbiAgICBpZiAoY21kID09PSAnaGFza3RhZ3MuanMnKSB7XG4gICAgICBjbWQgPSBgJHtfX2Rpcm5hbWV9JHtzZXB9Li4ke3NlcH1iaW4ke3NlcH1oYXNrdGFncy5qc2BcbiAgICAgIEJQID0gQnVmZmVyZWROb2RlUHJvY2Vzc1xuICAgIH0gZWxzZSB7XG4gICAgICBCUCA9IEJ1ZmZlcmVkUHJvY2Vzc1xuICAgIH1cbiAgICBjb25zdCBoYXNrdGFnc0FyZ3MgPSBbJy1lUm8tJ11cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC1oYXNrdGFncy5pZ25vcmVDbG9zZUltcGxlbWVudGF0aW9uJykpIHtcbiAgICAgIGhhc2t0YWdzQXJncy5wdXNoKCctLWlnbm9yZS1jbG9zZS1pbXBsZW1lbnRhdGlvbicpXG4gICAgfVxuICAgIGhhc2t0YWdzQXJncy5wdXNoKHBhdGgpXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVudXNlZC1leHByZXNzaW9uXG4gICAgbmV3IEJQKHtcbiAgICAgIGNvbW1hbmQ6IGNtZCxcbiAgICAgIGFyZ3M6IGhhc2t0YWdzQXJncyxcbiAgICAgIHN0ZG91dDogKGRhdGE6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBsaW5lcyA9IGRhdGEuc3BsaXQoRU9MKVxuICAgICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMuc2xpY2UoMCwgLTEpKSB7XG4gICAgICAgICAgc3dpdGNoICh0cnVlKSB7XG4gICAgICAgICAgICBjYXNlIGxpbmUgPT09ICdcXHgwYyc6XG4gICAgICAgICAgICAgIGZuID0gdHJ1ZVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSBmbjpcbiAgICAgICAgICAgICAgZm4gPSBmYWxzZVxuICAgICAgICAgICAgICBjb25zdCByZXMgPSAvXiguKiksXFxkKyQvLmV4ZWMobGluZSlcbiAgICAgICAgICAgICAgaWYgKHJlcyA9PT0gbnVsbCkgY29udGludWVcbiAgICAgICAgICAgICAgY29uc3QgWywgc3JjXSA9IHJlc1xuICAgICAgICAgICAgICBjdXJmaWxlID0gbmV3IE1hcCgpXG4gICAgICAgICAgICAgIHRoaXMudGFncy5zZXQoc3JjLCBjdXJmaWxlKVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgY29uc3QgcnhyID0gL14oLiopXFx4N2YoLiopXFx4MDEoXFxkKyksKFxcZCspJC8uZXhlYyhsaW5lKVxuICAgICAgICAgICAgICBpZiAocnhyID09PSBudWxsKSBjb250aW51ZVxuICAgICAgICAgICAgICBjb25zdCBbLCBjb250ZXh0LCB0YWdOYW1lLCBsaW5lTm9dID0gcnhyXG4gICAgICAgICAgICAgIGxldCBvYmogPSBjdXJmaWxlLmdldCh0YWdOYW1lKVxuICAgICAgICAgICAgICBpZiAob2JqID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBvYmogPSBbXVxuICAgICAgICAgICAgICAgIGN1cmZpbGUuc2V0KHRhZ05hbWUsIG9iailcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBvYmoucHVzaCh7IGNvbnRleHQsIGxpbmU6IHBhcnNlSW50KGxpbmVObywgMTApIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZXhpdDogKCkgPT4geyB0aGlzLmluUHJvZ3Jlc3MgPSBmYWxzZSB9LFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgbGlzdFRhZ3ModXJpPzogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzOiBTeW1SZWNbXSA9IFtdXG4gICAgaWYgKCF1cmkpIHtcbiAgICAgIHRoaXMudGFncy5mb3JFYWNoKFxuICAgICAgICAodGFnTWFwLCB1cmkpID0+XG4gICAgICAgICAgdGFnTWFwLmZvckVhY2goKGxpbmVzLCB0YWcpID0+XG4gICAgICAgICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT5cbiAgICAgICAgICAgICAgcmVzLnB1c2goeyB0YWcsIHVyaSwgY29udGV4dCwgbGluZSB9KSxcbiAgICAgICkpKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB0YWdNYXAgPSB0aGlzLnRhZ3MuZ2V0KHVyaSlcbiAgICAgIGlmICh0YWdNYXAgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0YWdNYXAuZm9yRWFjaCgobGluZXMsIHRhZykgPT5cbiAgICAgICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT5cbiAgICAgICAgICAgIHJlcy5wdXNoKHsgdGFnLCB1cmksIGNvbnRleHQsIGxpbmUgfSksXG4gICAgICAgICAgKSxcbiAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwdWJsaWMgZmluZFRhZyh0YWc6IHN0cmluZykge1xuICAgIGNvbnN0IHJlczogU3ltUmVjW10gPSBbXVxuICAgIHRoaXMudGFncy5mb3JFYWNoKCh0YWdNYXAsIHVyaSkgPT4ge1xuICAgICAgY29uc3QgbGluZXMgPSB0YWdNYXAuZ2V0KHRhZylcbiAgICAgIGlmIChsaW5lcyA9PT0gdW5kZWZpbmVkKSByZXR1cm5cbiAgICAgIGxpbmVzLmZvckVhY2goKHsgY29udGV4dCwgbGluZSB9KSA9PiB7XG4gICAgICAgIHJlcy5wdXNoKHsgdGFnLCB1cmksIGNvbnRleHQsIGxpbmUgfSlcbiAgICAgIH0pXG4gICAgfSlcbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwcml2YXRlIGZpbGVzQ2hhbmdlZCA9IChldnRzOiBGaWxlc3lzdGVtQ2hhbmdlRXZlbnQpID0+IHtcbiAgICBmb3IgKGNvbnN0IGV2dCBvZiBldnRzKSB7XG4gICAgICBpZiAoISBldnQucGF0aC5lbmRzV2l0aCgnLmhzJykgJiYgISBldnQucGF0aC5lbmRzV2l0aCgnLmxocycpKSBjb250aW51ZVxuICAgICAgc3dpdGNoIChldnQuYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgJ2NyZWF0ZWQnOlxuICAgICAgICAgIHRoaXMudXBkYXRlKGV2dC5wYXRoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ21vZGlmaWVkJzpcbiAgICAgICAgICB0aGlzLnVwZGF0ZShldnQucGF0aClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdkZWxldGVkJzpcbiAgICAgICAgICB0aGlzLnRhZ3MuZGVsZXRlKGV2dC5wYXRoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ3JlbmFtZWQnOlxuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgICAgdGhpcy50YWdzLmRlbGV0ZShldnQub2xkUGF0aCEpXG4gICAgICAgICAgdGhpcy51cGRhdGUoZXZ0LnBhdGgpXG4gICAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhdGhzQ2hhbmdlZCA9IChwYXRoczogc3RyaW5nW10pID0+IHtcbiAgICBjb25zdCByZW1vdmVkUGF0aHMgPSB0aGlzLnBhdGhzLmZpbHRlcihwID0+ICEgcGF0aHMuaW5jbHVkZXMocCkpXG4gICAgY29uc3QgYWRkZWRQYXRocyA9IHBhdGhzLmZpbHRlcihwID0+ICEgdGhpcy5wYXRocy5pbmNsdWRlcyhwKSlcbiAgICBjb25zb2xlLmVycm9yKCdwYXRoc0NoYW5nZWQnLCByZW1vdmVkUGF0aHMsIGFkZGVkUGF0aHMpXG4gICAgaWYgKHJlbW92ZWRQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBBcnJheS5mcm9tKHRoaXMudGFncy5rZXlzKCkpLmZpbHRlcihcbiAgICAgICAgZiA9PiByZW1vdmVkUGF0aHMuc29tZShwID0+IGYuc3RhcnRzV2l0aChwICsgc2VwKSksXG4gICAgICApLmZvckVhY2goayA9PiB0aGlzLnRhZ3MuZGVsZXRlKGspKVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IHBhdGggb2YgYWRkZWRQYXRocykge1xuICAgICAgdGhpcy51cGRhdGUocGF0aClcbiAgICB9XG4gICAgdGhpcy5wYXRocyA9IHBhdGhzXG4gIH1cbn1cbiJdfQ==