"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const os_1 = require("os");
const path_1 = require("path");
class Tags {
    constructor() {
        this.inProgress = false;
        this.disposables = new atom_1.CompositeDisposable();
        this.tags = new Map();
        this.paths = atom.project.getPaths();
        this.filesChanged = (evts) => {
            for (const evt of evts) {
                if (!evt.path.endsWith('.hs') && !evt.path.endsWith('.lhs'))
                    continue;
                switch (evt.action) {
                    case 'created':
                        this.update(evt.path);
                        break;
                    case 'modified':
                        this.update(evt.path);
                        break;
                    case 'deleted':
                        this.tags.delete(evt.path);
                        break;
                    case 'renamed':
                        this.tags.delete(evt.oldPath);
                        this.update(evt.path);
                        break;
                }
            }
        };
        this.pathsChanged = (paths) => {
            const removedPaths = this.paths.filter(p => !paths.includes(p));
            const addedPaths = paths.filter(p => !this.paths.includes(p));
            console.error('pathsChanged', removedPaths, addedPaths);
            if (removedPaths.length > 0) {
                Array.from(this.tags.keys()).filter(f => removedPaths.some(p => f.startsWith(p + path_1.sep))).forEach(k => this.tags.delete(k));
            }
            for (const path of addedPaths) {
                this.update(path);
            }
            this.paths = paths;
        };
        this.disposables.add(atom.project.onDidChangeFiles(this.filesChanged));
        this.disposables.add(atom.project.onDidChangePaths(this.pathsChanged));
        for (const path of this.paths) {
            this.update(path);
        }
    }
    destroy() {
        this.disposables.dispose();
        this.tags.clear();
    }
    update(path) {
        this.inProgress = true;
        let fn = false;
        let curfile = new Map();
        let cmd = atom.config.get('ide-haskell-hasktags.hasktagsPath');
        if (!cmd)
            return;
        let BP;
        if (cmd === 'hasktags.js') {
            cmd = require.resolve('@atom-haskell/hasktags-js');
            BP = atom_1.BufferedNodeProcess;
        }
        else {
            BP = atom_1.BufferedProcess;
        }
        const hasktagsArgs = ['-eRo-'];
        if (atom.config.get('ide-haskell-hasktags.ignoreCloseImplementation')) {
            hasktagsArgs.push('--ignore-close-implementation');
        }
        hasktagsArgs.push(path);
        new BP({
            command: cmd,
            args: hasktagsArgs,
            stdout: (data) => {
                const lines = data.split(os_1.EOL);
                for (const line of lines.slice(0, -1)) {
                    switch (true) {
                        case line === '\x0c':
                            fn = true;
                            break;
                        case fn:
                            fn = false;
                            const res = /^(.*),\d+$/.exec(line);
                            if (res === null)
                                continue;
                            const [, src] = res;
                            curfile = new Map();
                            this.tags.set(src, curfile);
                            break;
                        default:
                            const rxr = /^(.*)\x7f(.*)\x01(\d+),(\d+)$/.exec(line);
                            if (rxr === null)
                                continue;
                            const [, context, tagName, lineNo] = rxr;
                            let obj = curfile.get(tagName);
                            if (obj === undefined) {
                                obj = [];
                                curfile.set(tagName, obj);
                            }
                            obj.push({ context, line: parseInt(lineNo, 10) });
                    }
                }
            },
            exit: () => { this.inProgress = false; },
        });
    }
    listTags(uri) {
        const res = [];
        if (!uri) {
            this.tags.forEach((tagMap, uri) => tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line }))));
        }
        else {
            const tagMap = this.tags.get(uri);
            if (tagMap !== undefined) {
                tagMap.forEach((lines, tag) => lines.forEach(({ context, line }) => res.push({ tag, uri, context, line })));
            }
        }
        return res;
    }
    findTag(tag) {
        const res = [];
        this.tags.forEach((tagMap, uri) => {
            const lines = tagMap.get(tag);
            if (lines === undefined)
                return;
            lines.forEach(({ context, line }) => {
                res.push({ tag, uri, context, line });
            });
        });
        return res;
    }
}
exports.Tags = Tags;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90YWdzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXVHO0FBQ3ZHLDJCQUF3QjtBQUN4QiwrQkFBMEI7QUFVMUI7SUFLRTtRQUpPLGVBQVUsR0FBWSxLQUFLLENBQUE7UUFDMUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDdkMsU0FBSSxHQUFRLElBQUksR0FBRyxFQUFFLENBQUE7UUFDckIsVUFBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUE7UUFzRy9CLGlCQUFZLEdBQUcsQ0FBQyxJQUEyQixFQUFFLEVBQUU7WUFDckQsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdkIsRUFBRSxDQUFDLENBQUMsQ0FBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUFDLFFBQVEsQ0FBQTtnQkFDdkUsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ25CLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO29CQUNQLEtBQUssVUFBVTt3QkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDckIsS0FBSyxDQUFBO29CQUNQLEtBQUssU0FBUzt3QkFDWixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7d0JBQzFCLEtBQUssQ0FBQTtvQkFDUCxLQUFLLFNBQVM7d0JBRVosSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMs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QUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7WUFDdkMsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtRQUNGLE1BQU0sQ0FBQyxHQUFHLENBQUE7SUFDWixDQUFDO0NBc0NGO0FBOUlELG9CQThJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIEJ1ZmZlcmVkUHJvY2VzcywgQnVmZmVyZWROb2RlUHJvY2VzcywgRmlsZXN5c3RlbUNoYW5nZUV2ZW50IH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJ1xuaW1wb3J0IHsgc2VwIH0gZnJvbSAncGF0aCdcblxuaW50ZXJmYWNlIExpbmVSZWMge1xuICBjb250ZXh0OiBzdHJpbmdcbiAgbGluZTogbnVtYmVyXG59XG5cbnR5cGUgRmlsZVJlYyA9IE1hcDxzdHJpbmcsIExpbmVSZWNbXT5cbnR5cGUgUmVjID0gTWFwPHN0cmluZywgRmlsZVJlYz5cblxuZXhwb3J0IGNsYXNzIFRhZ3Mge1xuICBwdWJsaWMgaW5Qcm9ncmVzczogYm9vbGVhbiA9IGZhbHNlXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgdGFnczogUmVjID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgcGF0aHMgPSBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLnByb2plY3Qub25EaWRDaGFuZ2VGaWxlcyh0aGlzLmZpbGVzQ2hhbmdlZCkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHModGhpcy5wYXRoc0NoYW5nZWQpKVxuICAgIGZvciAoY29uc3QgcGF0aCBvZiB0aGlzLnBhdGhzKSB7XG4gICAgICB0aGlzLnVwZGF0ZShwYXRoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdGhpcy50YWdzLmNsZWFyKClcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUocGF0aDogc3RyaW5nKSB7XG4gICAgdGhpcy5pblByb2dyZXNzID0gdHJ1ZVxuICAgIGxldCBmbjogYm9vbGVhbiA9IGZhbHNlXG4gICAgbGV0IGN1cmZpbGU6IE1hcDxzdHJpbmcsIExpbmVSZWNbXT4gPSBuZXcgTWFwKClcbiAgICBsZXQgY21kOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLWhhc2t0YWdzLmhhc2t0YWdzUGF0aCcpXG4gICAgaWYgKCFjbWQpIHJldHVyblxuICAgIGxldCBCUFxuICAgIGlmIChjbWQgPT09ICdoYXNrdGFncy5qcycpIHtcbiAgICAgIGNtZCA9IHJlcXVpcmUucmVzb2x2ZSgnQGF0b20taGFza2VsbC9oYXNrdGFncy1qcycpXG4gICAgICBCUCA9IEJ1ZmZlcmVkTm9kZVByb2Nlc3NcbiAgICB9IGVsc2Uge1xuICAgICAgQlAgPSBCdWZmZXJlZFByb2Nlc3NcbiAgICB9XG4gICAgY29uc3QgaGFza3RhZ3NBcmdzID0gWyctZVJvLSddXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwtaGFza3RhZ3MuaWdub3JlQ2xvc2VJbXBsZW1lbnRhdGlvbicpKSB7XG4gICAgICBoYXNrdGFnc0FyZ3MucHVzaCgnLS1pZ25vcmUtY2xvc2UtaW1wbGVtZW50YXRpb24nKVxuICAgIH1cbiAgICBoYXNrdGFnc0FyZ3MucHVzaChwYXRoKVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnVzZWQtZXhwcmVzc2lvblxuICAgIG5ldyBCUCh7XG4gICAgICBjb21tYW5kOiBjbWQsXG4gICAgICBhcmdzOiBoYXNrdGFnc0FyZ3MsXG4gICAgICBzdGRvdXQ6IChkYXRhOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgbGluZXMgPSBkYXRhLnNwbGl0KEVPTClcbiAgICAgICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzLnNsaWNlKDAsIC0xKSkge1xuICAgICAgICAgIHN3aXRjaCAodHJ1ZSkge1xuICAgICAgICAgICAgY2FzZSBsaW5lID09PSAnXFx4MGMnOlxuICAgICAgICAgICAgICBmbiA9IHRydWVcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGNhc2UgZm46XG4gICAgICAgICAgICAgIGZuID0gZmFsc2VcbiAgICAgICAgICAgICAgY29uc3QgcmVzID0gL14oLiopLFxcZCskLy5leGVjKGxpbmUpXG4gICAgICAgICAgICAgIGlmIChyZXMgPT09IG51bGwpIGNvbnRpbnVlXG4gICAgICAgICAgICAgIGNvbnN0IFssIHNyY10gPSByZXNcbiAgICAgICAgICAgICAgY3VyZmlsZSA9IG5ldyBNYXAoKVxuICAgICAgICAgICAgICB0aGlzLnRhZ3Muc2V0KHNyYywgY3VyZmlsZSlcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIGNvbnN0IHJ4ciA9IC9eKC4qKVxceDdmKC4qKVxceDAxKFxcZCspLChcXGQrKSQvLmV4ZWMobGluZSlcbiAgICAgICAgICAgICAgaWYgKHJ4ciA9PT0gbnVsbCkgY29udGludWVcbiAgICAgICAgICAgICAgY29uc3QgWywgY29udGV4dCwgdGFnTmFtZSwgbGluZU5vXSA9IHJ4clxuICAgICAgICAgICAgICBsZXQgb2JqID0gY3VyZmlsZS5nZXQodGFnTmFtZSlcbiAgICAgICAgICAgICAgaWYgKG9iaiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgb2JqID0gW11cbiAgICAgICAgICAgICAgICBjdXJmaWxlLnNldCh0YWdOYW1lLCBvYmopXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgb2JqLnB1c2goeyBjb250ZXh0LCBsaW5lOiBwYXJzZUludChsaW5lTm8sIDEwKSB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGV4aXQ6ICgpID0+IHsgdGhpcy5pblByb2dyZXNzID0gZmFsc2UgfSxcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGxpc3RUYWdzKHVyaT86IHN0cmluZykge1xuICAgIGNvbnN0IHJlczogU3ltUmVjW10gPSBbXVxuICAgIGlmICghdXJpKSB7XG4gICAgICB0aGlzLnRhZ3MuZm9yRWFjaChcbiAgICAgICAgKHRhZ01hcCwgdXJpKSA9PlxuICAgICAgICAgIHRhZ01hcC5mb3JFYWNoKChsaW5lcywgdGFnKSA9PlxuICAgICAgICAgICAgbGluZXMuZm9yRWFjaCgoeyBjb250ZXh0LCBsaW5lIH0pID0+XG4gICAgICAgICAgICAgIHJlcy5wdXNoKHsgdGFnLCB1cmksIGNvbnRleHQsIGxpbmUgfSksXG4gICAgICApKSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdGFnTWFwID0gdGhpcy50YWdzLmdldCh1cmkpXG4gICAgICBpZiAodGFnTWFwICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGFnTWFwLmZvckVhY2goKGxpbmVzLCB0YWcpID0+XG4gICAgICAgICAgbGluZXMuZm9yRWFjaCgoeyBjb250ZXh0LCBsaW5lIH0pID0+XG4gICAgICAgICAgICByZXMucHVzaCh7IHRhZywgdXJpLCBjb250ZXh0LCBsaW5lIH0pLFxuICAgICAgICAgICksXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgcHVibGljIGZpbmRUYWcodGFnOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXM6IFN5bVJlY1tdID0gW11cbiAgICB0aGlzLnRhZ3MuZm9yRWFjaCgodGFnTWFwLCB1cmkpID0+IHtcbiAgICAgIGNvbnN0IGxpbmVzID0gdGFnTWFwLmdldCh0YWcpXG4gICAgICBpZiAobGluZXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuXG4gICAgICBsaW5lcy5mb3JFYWNoKCh7IGNvbnRleHQsIGxpbmUgfSkgPT4ge1xuICAgICAgICByZXMucHVzaCh7IHRhZywgdXJpLCBjb250ZXh0LCBsaW5lIH0pXG4gICAgICB9KVxuICAgIH0pXG4gICAgcmV0dXJuIHJlc1xuICB9XG5cbiAgcHJpdmF0ZSBmaWxlc0NoYW5nZWQgPSAoZXZ0czogRmlsZXN5c3RlbUNoYW5nZUV2ZW50KSA9PiB7XG4gICAgZm9yIChjb25zdCBldnQgb2YgZXZ0cykge1xuICAgICAgaWYgKCEgZXZ0LnBhdGguZW5kc1dpdGgoJy5ocycpICYmICEgZXZ0LnBhdGguZW5kc1dpdGgoJy5saHMnKSkgY29udGludWVcbiAgICAgIHN3aXRjaCAoZXZ0LmFjdGlvbikge1xuICAgICAgICBjYXNlICdjcmVhdGVkJzpcbiAgICAgICAgICB0aGlzLnVwZGF0ZShldnQucGF0aClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdtb2RpZmllZCc6XG4gICAgICAgICAgdGhpcy51cGRhdGUoZXZ0LnBhdGgpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnZGVsZXRlZCc6XG4gICAgICAgICAgdGhpcy50YWdzLmRlbGV0ZShldnQucGF0aClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdyZW5hbWVkJzpcbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgIHRoaXMudGFncy5kZWxldGUoZXZ0Lm9sZFBhdGghKVxuICAgICAgICAgIHRoaXMudXBkYXRlKGV2dC5wYXRoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXRoc0NoYW5nZWQgPSAocGF0aHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgY29uc3QgcmVtb3ZlZFBhdGhzID0gdGhpcy5wYXRocy5maWx0ZXIocCA9PiAhIHBhdGhzLmluY2x1ZGVzKHApKVxuICAgIGNvbnN0IGFkZGVkUGF0aHMgPSBwYXRocy5maWx0ZXIocCA9PiAhIHRoaXMucGF0aHMuaW5jbHVkZXMocCkpXG4gICAgY29uc29sZS5lcnJvcigncGF0aHNDaGFuZ2VkJywgcmVtb3ZlZFBhdGhzLCBhZGRlZFBhdGhzKVxuICAgIGlmIChyZW1vdmVkUGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgQXJyYXkuZnJvbSh0aGlzLnRhZ3Mua2V5cygpKS5maWx0ZXIoXG4gICAgICAgIGYgPT4gcmVtb3ZlZFBhdGhzLnNvbWUocCA9PiBmLnN0YXJ0c1dpdGgocCArIHNlcCkpLFxuICAgICAgKS5mb3JFYWNoKGsgPT4gdGhpcy50YWdzLmRlbGV0ZShrKSlcbiAgICB9XG4gICAgZm9yIChjb25zdCBwYXRoIG9mIGFkZGVkUGF0aHMpIHtcbiAgICAgIHRoaXMudXBkYXRlKHBhdGgpXG4gICAgfVxuICAgIHRoaXMucGF0aHMgPSBwYXRoc1xuICB9XG59XG4iXX0=