"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const tags_1 = require("./tags");
const tags_list_view_1 = require("./tags-list-view");
var config_1 = require("./config");
exports.config = config_1.config;
let stack;
let disposables;
async function showList(editor, tags) {
    const tag = await tags_list_view_1.selectListView(tags, exports.tagsInstance.inProgress);
    if (tag !== undefined)
        open(editor, tag);
}
function open(editor, tag) {
    const edp = editor.getPath();
    if (edp) {
        stack.push({
            uri: edp,
            line: editor.getLastCursor().getBufferRow(),
            column: editor.getLastCursor().getBufferColumn(),
        });
    }
    void atom.workspace.open(tag.uri, {
        initialLine: tag.line,
        searchAllPanes: true,
    });
}
function activate() {
    stack = [];
    exports.tagsInstance = new tags_1.Tags();
    disposables = new atom_1.CompositeDisposable();
    disposables.add(atom.commands.add('atom-workspace', {
        'ide-haskell-hasktags:show-tags': () => {
            if (!exports.tagsInstance)
                return;
            const ed = atom.workspace.getActiveTextEditor();
            if (ed)
                void showList(ed, exports.tagsInstance.listTags());
        },
        'ide-haskell-hasktags:go-back': () => {
            const prevpos = stack.pop();
            if (prevpos) {
                void atom.workspace.open(prevpos.uri, {
                    initialLine: prevpos.line,
                    initialColumn: prevpos.column,
                    searchAllPanes: true,
                });
            }
        },
    }));
    disposables.add(atom.commands.add('atom-text-editor', {
        'ide-haskell-hasktags:show-file-tags': ({ currentTarget }) => {
            if (!exports.tagsInstance)
                return;
            const editor = currentTarget.getModel();
            const path = editor.getPath();
            if (!path)
                return;
            void showList(editor, exports.tagsInstance.listTags(path));
        },
    }));
    disposables.add(atom.contextMenu.add({
        'atom-text-editor[data-grammar~="haskell"]': [{
                label: 'Show File Tags',
                command: 'ide-haskell-hasktags:show-file-tags',
            }],
    }));
    disposables.add(atom.menu.add([{
            label: 'Haskell IDE',
            submenu: [{
                    label: 'Hasktags',
                    submenu: [{
                            label: 'Show Tags',
                            command: 'ide-haskell-hasktags:show-tags',
                        }, {
                            label: 'Show File Tags',
                            command: 'ide-haskell-hasktags:show-file-tags',
                        }],
                }],
        }]));
}
exports.activate = activate;
function consumeUPI(register) {
    const upi = register({
        name: 'ide-haskell-hasktags',
    });
    const disp = new atom_1.CompositeDisposable();
    disposables.add(disp);
    disp.add(upi);
    disp.add(atom.commands.add('atom-text-editor', {
        'ide-haskell-hasktags:go-to-declaration': ({ currentTarget, detail }) => {
            if (!exports.tagsInstance)
                return;
            const editor = currentTarget.getModel();
            const buffer = editor.getBuffer();
            const er = upi.getEventRange(editor, detail);
            if (!er)
                return;
            const { crange } = er;
            const { start, end } = buffer.rangeForRow(crange.start.row, false);
            const crange2 = { start: crange.start, end: crange.end };
            const left = buffer.getTextInRange([start, crange.start]);
            crange2.start.column = left.search(/[\w']*$/);
            const right = buffer.getTextInRange([crange.end, end]);
            crange2.end.column += right.search(/[^\w']|$/);
            const symbol = buffer.getTextInRange(crange2);
            const tags = exports.tagsInstance.findTag(symbol);
            switch (tags.length) {
                case 0: return;
                case 1:
                    void open(editor, tags[0]);
                    break;
                default: void showList(editor, tags);
            }
        },
    }));
    disp.add(atom.contextMenu.add({
        'atom-text-editor[data-grammar~="haskell"]': [{
                label: 'Go to Declaration',
                command: 'ide-haskell-hasktags:go-to-declaration',
            }],
    }));
    return disp;
}
exports.consumeUPI = consumeUPI;
function deactivate() {
    disposables.dispose();
    exports.tagsInstance.destroy();
}
exports.deactivate = deactivate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwtaGFza3RhZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaWRlLWhhc2tlbGwtaGFza3RhZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBc0Q7QUFDdEQsaUNBQTZCO0FBQzdCLHFEQUFpRDtBQUdqRCxtQ0FBaUM7QUFBeEIsMEJBQUEsTUFBTSxDQUFBO0FBR2YsSUFBSSxLQUlGLENBQUE7QUFDRixJQUFJLFdBQWdDLENBQUE7QUFFcEMsS0FBSyxtQkFBbUIsTUFBa0IsRUFBRSxJQUFjO0lBQ3hELE1BQU0sR0FBRyxHQUFHLE1BQU0sK0JBQWMsQ0FBQyxJQUFJLEVBQUUsb0JBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUMvRCxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssU0FBUyxDQUFDO1FBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQTtBQUMxQyxDQUFDO0FBRUQsY0FBYyxNQUFrQixFQUFFLEdBQVc7SUFFM0MsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQzVCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDUixLQUFLLENBQUMsSUFBSSxDQUFDO1lBQ1QsR0FBRyxFQUFFLEdBQUc7WUFDUixJQUFJLEVBQUUsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDLFlBQVksRUFBRTtZQUMzQyxNQUFNLEVBQUUsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDLGVBQWUsRUFBRTtTQUNqRCxDQUFDLENBQUE7SUFDSixDQUFDO0lBQ0QsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO1FBQ2hDLFdBQVcsRUFBRSxHQUFHLENBQUMsSUFBSTtRQUNyQixjQUFjLEVBQUUsSUFBSTtLQUNyQixDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQ7SUFDRSxLQUFLLEdBQUcsRUFBRSxDQUFBO0lB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QUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDOUMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUM3QyxNQUFNLElBQUksR0FBRyxvQkFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUN6QyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDcEIsS0FBSyxDQUFDLEVBQUUsTUFBTSxDQUFBO2dCQUNkLEtBQUssQ0FBQztvQkFBRSxLQUFLLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQUMsS0FBSyxDQUFBO2dCQUN6QyxTQUFTLEtBQUssUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUN0QyxDQUFDO1FBQ0gsQ0FBQztLQUNGLENBQUMsQ0FBQyxDQUFBO0lBRUgsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQztRQUM1QiwyQ0FBMkMsRUFBRSxDQUFDO2dCQUM1QyxLQUFLLEVBQUUsbUJBQW1CO2dCQUMxQixPQUFPLEVBQUUsd0NBQXdDO2FBQ2xELENBQUM7S0FDSCxDQUFDLENBQUMsQ0FBQTtJQUVILE1BQU0sQ0FBQyxJQUFJLENBQUE7QUFDYixDQUFDO0FBeENELGdDQXdDQztBQUVEO0lBQ0UsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ3JCLG9CQUFZLENBQUMsT0FBTyxFQUFFLENBQUE7QUFDeEIsQ0FBQztBQUhELGdDQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgVGV4dEVkaXRvciB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBUYWdzIH0gZnJvbSAnLi90YWdzJ1xuaW1wb3J0IHsgc2VsZWN0TGlzdFZpZXcgfSBmcm9tICcuL3RhZ3MtbGlzdC12aWV3J1xuaW1wb3J0IHsgSVVQSVJlZ2lzdHJhdGlvbiB9IGZyb20gJ2F0b20taGFza2VsbC11cGknXG5cbmV4cG9ydCB7IGNvbmZpZyB9IGZyb20gJy4vY29uZmlnJ1xuXG5leHBvcnQgbGV0IHRhZ3NJbnN0YW5jZTogVGFnc1xubGV0IHN0YWNrOiBBcnJheTx7XG4gIHVyaTogc3RyaW5nXG4gIGxpbmU6IG51bWJlclxuICBjb2x1bW46IG51bWJlclxufT5cbmxldCBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuXG5hc3luYyBmdW5jdGlvbiBzaG93TGlzdChlZGl0b3I6IFRleHRFZGl0b3IsIHRhZ3M6IFN5bVJlY1tdKSB7XG4gIGNvbnN0IHRhZyA9IGF3YWl0IHNlbGVjdExpc3RWaWV3KHRhZ3MsIHRhZ3NJbnN0YW5jZS5pblByb2dyZXNzKVxuICBpZiAodGFnICE9PSB1bmRlZmluZWQpIG9wZW4oZWRpdG9yLCB0YWcpXG59XG5cbmZ1bmN0aW9uIG9wZW4oZWRpdG9yOiBUZXh0RWRpdG9yLCB0YWc6IFN5bVJlYykge1xuICAvLyBlZGl0b3IgPz0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gIGNvbnN0IGVkcCA9IGVkaXRvci5nZXRQYXRoKClcbiAgaWYgKGVkcCkge1xuICAgIHN0YWNrLnB1c2goe1xuICAgICAgdXJpOiBlZHAsXG4gICAgICBsaW5lOiBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldEJ1ZmZlclJvdygpLFxuICAgICAgY29sdW1uOiBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldEJ1ZmZlckNvbHVtbigpLFxuICAgIH0pXG4gIH1cbiAgdm9pZCBhdG9tLndvcmtzcGFjZS5vcGVuKHRhZy51cmksIHtcbiAgICBpbml0aWFsTGluZTogdGFnLmxpbmUsXG4gICAgc2VhcmNoQWxsUGFuZXM6IHRydWUsXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgc3RhY2sgPSBbXVxuICB0YWdzSW5zdGFuY2UgPSBuZXcgVGFncygpXG4gIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBkaXNwb3NhYmxlcy5hZGQoYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywge1xuICAgICdpZGUtaGFza2VsbC1oYXNrdGFnczpzaG93LXRhZ3MnOiAoKSA9PiB7XG4gICAgICBpZiAoIXRhZ3NJbnN0YW5jZSkgcmV0dXJuXG4gICAgICBjb25zdCBlZCA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICAgICAgaWYgKGVkKSB2b2lkIHNob3dMaXN0KGVkLCB0YWdzSW5zdGFuY2UubGlzdFRhZ3MoKSlcbiAgICB9LFxuICAgICdpZGUtaGFza2VsbC1oYXNrdGFnczpnby1iYWNrJzogKCkgPT4ge1xuICAgICAgY29uc3QgcHJldnBvcyA9IHN0YWNrLnBvcCgpXG4gICAgICBpZiAocHJldnBvcykge1xuICAgICAgICB2b2lkIGF0b20ud29ya3NwYWNlLm9wZW4ocHJldnBvcy51cmksIHtcbiAgICAgICAgICBpbml0aWFsTGluZTogcHJldnBvcy5saW5lLFxuICAgICAgICAgIGluaXRpYWxDb2x1bW46IHByZXZwb3MuY29sdW1uLFxuICAgICAgICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0sXG4gIH0pKVxuICBkaXNwb3NhYmxlcy5hZGQoYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3InLCB7XG4gICAgJ2lkZS1oYXNrZWxsLWhhc2t0YWdzOnNob3ctZmlsZS10YWdzJzogKHsgY3VycmVudFRhcmdldCB9KSA9PiB7XG4gICAgICBpZiAoIXRhZ3NJbnN0YW5jZSkgcmV0dXJuXG4gICAgICBjb25zdCBlZGl0b3I6IFRleHRFZGl0b3IgPSAoY3VycmVudFRhcmdldCBhcyBhbnkpLmdldE1vZGVsKClcbiAgICAgIGNvbnN0IHBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpXG4gICAgICBpZiAoIXBhdGgpIHJldHVyblxuICAgICAgdm9pZCBzaG93TGlzdChlZGl0b3IsIHRhZ3NJbnN0YW5jZS5saXN0VGFncyhwYXRoKSlcbiAgICB9LFxuICB9KSlcbiAgZGlzcG9zYWJsZXMuYWRkKGF0b20uY29udGV4dE1lbnUuYWRkKHtcbiAgICAnYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXJ+PVwiaGFza2VsbFwiXSc6IFt7XG4gICAgICBsYWJlbDogJ1Nob3cgRmlsZSBUYWdzJyxcbiAgICAgIGNvbW1hbmQ6ICdpZGUtaGFza2VsbC1oYXNrdGFnczpzaG93LWZpbGUtdGFncycsXG4gICAgfV0sXG4gIH0pKVxuICBkaXNwb3NhYmxlcy5hZGQoYXRvbS5tZW51LmFkZChbe1xuICAgIGxhYmVsOiAnSGFza2VsbCBJREUnLFxuICAgIHN1Ym1lbnU6IFt7XG4gICAgICBsYWJlbDogJ0hhc2t0YWdzJyxcbiAgICAgIHN1Ym1lbnU6IFt7XG4gICAgICAgIGxhYmVsOiAnU2hvdyBUYWdzJyxcbiAgICAgICAgY29tbWFuZDogJ2lkZS1oYXNrZWxsLWhhc2t0YWdzOnNob3ctdGFncycsXG4gICAgICB9LCB7XG4gICAgICAgIGxhYmVsOiAnU2hvdyBGaWxlIFRhZ3MnLFxuICAgICAgICBjb21tYW5kOiAnaWRlLWhhc2tlbGwtaGFza3RhZ3M6c2hvdy1maWxlLXRhZ3MnLFxuICAgICAgfV0sXG4gICAgfV0sXG4gIH1dKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVVUEkocmVnaXN0ZXI6IElVUElSZWdpc3RyYXRpb24pIHtcbiAgY29uc3QgdXBpID0gcmVnaXN0ZXIoe1xuICAgIG5hbWU6ICdpZGUtaGFza2VsbC1oYXNrdGFncycsXG4gIH0pXG4gIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIGRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICBkaXNwLmFkZCh1cGkpXG5cbiAgZGlzcC5hZGQoYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3InLCB7XG4gICAgJ2lkZS1oYXNrZWxsLWhhc2t0YWdzOmdvLXRvLWRlY2xhcmF0aW9uJzogKHsgY3VycmVudFRhcmdldCwgZGV0YWlsIH0pID0+IHtcbiAgICAgIGlmICghdGFnc0luc3RhbmNlKSByZXR1cm5cbiAgICAgIGNvbnN0IGVkaXRvcjogVGV4dEVkaXRvciA9IChjdXJyZW50VGFyZ2V0IGFzIGFueSkuZ2V0TW9kZWwoKVxuICAgICAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpXG4gICAgICBjb25zdCBlciA9IHVwaS5nZXRFdmVudFJhbmdlKGVkaXRvciwgZGV0YWlsKVxuICAgICAgaWYgKCFlcikgcmV0dXJuXG4gICAgICBjb25zdCB7IGNyYW5nZSB9ID0gZXJcbiAgICAgIGNvbnN0IHsgc3RhcnQsIGVuZCB9ID0gYnVmZmVyLnJhbmdlRm9yUm93KGNyYW5nZS5zdGFydC5yb3csIGZhbHNlKVxuICAgICAgY29uc3QgY3JhbmdlMiA9IHsgc3RhcnQ6IGNyYW5nZS5zdGFydCwgZW5kOiBjcmFuZ2UuZW5kIH1cbiAgICAgIGNvbnN0IGxlZnQgPSBidWZmZXIuZ2V0VGV4dEluUmFuZ2UoW3N0YXJ0LCBjcmFuZ2Uuc3RhcnRdKVxuICAgICAgY3JhbmdlMi5zdGFydC5jb2x1bW4gPSBsZWZ0LnNlYXJjaCgvW1xcdyddKiQvKVxuICAgICAgY29uc3QgcmlnaHQgPSBidWZmZXIuZ2V0VGV4dEluUmFuZ2UoW2NyYW5nZS5lbmQsIGVuZF0pXG4gICAgICBjcmFuZ2UyLmVuZC5jb2x1bW4gKz0gcmlnaHQuc2VhcmNoKC9bXlxcdyddfCQvKVxuICAgICAgY29uc3Qgc3ltYm9sID0gYnVmZmVyLmdldFRleHRJblJhbmdlKGNyYW5nZTIpXG4gICAgICBjb25zdCB0YWdzID0gdGFnc0luc3RhbmNlLmZpbmRUYWcoc3ltYm9sKVxuICAgICAgc3dpdGNoICh0YWdzLmxlbmd0aCkge1xuICAgICAgICBjYXNlIDA6IHJldHVyblxuICAgICAgICBjYXNlIDE6IHZvaWQgb3BlbihlZGl0b3IsIHRhZ3NbMF0pOyBicmVha1xuICAgICAgICBkZWZhdWx0OiB2b2lkIHNob3dMaXN0KGVkaXRvciwgdGFncylcbiAgICAgIH1cbiAgICB9LFxuICB9KSlcblxuICBkaXNwLmFkZChhdG9tLmNvbnRleHRNZW51LmFkZCh7XG4gICAgJ2F0b20tdGV4dC1lZGl0b3JbZGF0YS1ncmFtbWFyfj1cImhhc2tlbGxcIl0nOiBbe1xuICAgICAgbGFiZWw6ICdHbyB0byBEZWNsYXJhdGlvbicsXG4gICAgICBjb21tYW5kOiAnaWRlLWhhc2tlbGwtaGFza3RhZ3M6Z28tdG8tZGVjbGFyYXRpb24nLFxuICAgIH1dLFxuICB9KSlcblxuICByZXR1cm4gZGlzcFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIHRhZ3NJbnN0YW5jZS5kZXN0cm95KClcbn1cbiJdfQ==