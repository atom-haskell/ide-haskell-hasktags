"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const tags_1 = require("./tags");
const tags_list_view_1 = require("./tags-list-view");
var config_1 = require("./config");
exports.config = config_1.config;
let stack;
let disposables;
let active = false;
async function showList(editor, tags) {
    const tag = await tags_list_view_1.selectListView(tags, exports.tagsInstance.inProgress);
    if (tag !== undefined)
        open(editor, tag);
}
function open(editor, tag) {
    const edp = editor.getPath();
    if (edp) {
        stack.push({
            uri: edp,
            line: editor.getLastCursor().getBufferRow(),
            column: editor.getLastCursor().getBufferColumn(),
        });
    }
    void atom.workspace.open(tag.uri, {
        initialLine: tag.line,
        searchAllPanes: true,
    });
}
function activate() {
    active = true;
    stack = [];
    exports.tagsInstance = new tags_1.Tags();
    disposables = new atom_1.CompositeDisposable();
    disposables.add(atom.commands.add('atom-workspace', {
        'ide-haskell-hasktags:show-tags': () => {
            if (!active)
                return;
            const ed = atom.workspace.getActiveTextEditor();
            if (ed)
                void showList(ed, exports.tagsInstance.listTags());
        },
        'ide-haskell-hasktags:go-back': () => {
            const prevpos = stack.pop();
            if (prevpos) {
                void atom.workspace.open(prevpos.uri, {
                    initialLine: prevpos.line,
                    initialColumn: prevpos.column,
                    searchAllPanes: true,
                });
            }
        },
    }));
    disposables.add(atom.commands.add('atom-text-editor', {
        'ide-haskell-hasktags:show-file-tags': ({ currentTarget }) => {
            if (!active)
                return;
            const editor = currentTarget.getModel();
            const path = editor.getPath();
            if (!path)
                return;
            void showList(editor, exports.tagsInstance.listTags(path));
        },
    }));
    disposables.add(atom.contextMenu.add({
        'atom-text-editor[data-grammar~="haskell"]': [{
                label: 'Show File Tags',
                command: 'ide-haskell-hasktags:show-file-tags',
            }],
    }));
    disposables.add(atom.menu.add([{
            label: 'Haskell IDE',
            submenu: [{
                    label: 'Hasktags',
                    submenu: [{
                            label: 'Show Tags',
                            command: 'ide-haskell-hasktags:show-tags',
                        }, {
                            label: 'Show File Tags',
                            command: 'ide-haskell-hasktags:show-file-tags',
                        }],
                }],
        }]));
}
exports.activate = activate;
function consumeUPI(register) {
    const upi = register({
        name: 'ide-haskell-hasktags',
    });
    const disp = new atom_1.CompositeDisposable();
    disposables.add(disp);
    disp.add(upi);
    disp.add(atom.commands.add('atom-text-editor', {
        'ide-haskell-hasktags:go-to-declaration': ({ currentTarget, detail }) => {
            if (!active)
                return;
            const editor = currentTarget.getModel();
            const buffer = editor.getBuffer();
            const er = upi.getEventRange(editor, detail);
            if (!er)
                return;
            const { crange } = er;
            const { start, end } = buffer.rangeForRow(crange.start.row, false);
            const crange2 = { start: crange.start, end: crange.end };
            const left = buffer.getTextInRange([start, crange.start]);
            crange2.start.column = left.search(/[\w']*$/);
            const right = buffer.getTextInRange([crange.end, end]);
            crange2.end.column += right.search(/[^\w']|$/);
            const symbol = buffer.getTextInRange(crange2);
            const tags = exports.tagsInstance.findTag(symbol);
            switch (tags.length) {
                case 0: return;
                case 1:
                    void open(editor, tags[0]);
                    break;
                default: void showList(editor, tags);
            }
        },
    }));
    disp.add(atom.contextMenu.add({
        'atom-text-editor[data-grammar~="haskell"]': [{
                label: 'Go to Declaration',
                command: 'ide-haskell-hasktags:go-to-declaration',
            }],
    }));
    return disp;
}
exports.consumeUPI = consumeUPI;
function deactivate() {
    disposables.dispose();
    exports.tagsInstance.destroy();
    active = false;
}
exports.deactivate = deactivate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwtaGFza3RhZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaWRlLWhhc2tlbGwtaGFza3RhZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBc0Q7QUFDdEQsaUNBQTZCO0FBQzdCLHFEQUFpRDtBQUdqRCxtQ0FBaUM7QUFBeEIsMEJBQUEsTUFBTSxDQUFBO0FBR2YsSUFBSSxLQUlGLENBQUE7QUFDRixJQUFJLFdBQWdDLENBQUE7QUFDcEMsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFBO0FBRWxCLEtBQUssbUJBQW1CLE1BQWtCLEVBQUUsSUFBYztJQUN4RCxNQUFNLEdBQUcsR0FBRyxNQUFNLCtCQUFjLENBQUMsSUFBSSxFQUFFLG9CQUFZLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDL0QsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLFNBQVMsQ0FBQztRQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUE7QUFDMUMsQ0FBQztBQUVELGNBQWMsTUFBa0IsRUFBRSxHQUFXO0lBRTNDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUM1QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1IsS0FBSyxDQUFDLElBQUksQ0FBQztZQUNULEdBQUcsRUFBRSxHQUFHO1lBQ1IsSUFBSSxFQUFFLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxZQUFZLEVBQUU7WUFDM0MsTUFBTSxFQUFFLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxlQUFlLEVBQUU7U0FDakQsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUNELEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtRQUNoQyxXQUFXLEVBQUUsR0FBRyxDQUFDLElBQUk7UUFDckIsY0FBYyxFQUFFLElBQUk7S0FDckIsQ0FBQyxDQUFBO0FBQ0osQ0FBQztB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R0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUE7WUFDdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUM5QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQzdDLE1BQU0sSUFBSSxHQUFHLG9CQUFZLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ3pDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixLQUFLLENBQUMsRUFBRSxNQUFNLENBQUE7Z0JBQ2QsS0FBSyxDQUFDO29CQUFFLEtBQUssSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFBQyxLQUFLLENBQUE7Z0JBQ3pDLFNBQVMsS0FBSyxRQUFRLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQ3RDLENBQUM7UUFDSCxDQUFDO0tBQ0YsQ0FBQyxDQUFDLENBQUE7SUFFSCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDO1FBQzVCLDJDQUEyQyxFQUFFLENBQUM7Z0JBQzVDLEtBQUssRUFBRSxtQkFBbUI7Z0JBQzFCLE9BQU8sRUFBRSx3Q0FBd0M7YUFDbEQsQ0FBQztLQUNILENBQUMsQ0FBQyxDQUFBO0lBRUgsTUFBTSxDQUFDLElBQUksQ0FBQTtBQUNiLENBQUM7QUF4Q0QsZ0NBd0NDO0FBRUQ7SUFDRSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDckIsb0JBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUN0QixNQUFNLEdBQUcsS0FBSyxDQUFBO0FBQ2hCLENBQUM7QUFKRCxnQ0FJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgVGFncyB9IGZyb20gJy4vdGFncydcbmltcG9ydCB7IHNlbGVjdExpc3RWaWV3IH0gZnJvbSAnLi90YWdzLWxpc3QtdmlldydcbmltcG9ydCB7IElVUElSZWdpc3RyYXRpb24gfSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuXG5leHBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZydcblxuZXhwb3J0IGxldCB0YWdzSW5zdGFuY2U6IFRhZ3NcbmxldCBzdGFjazogQXJyYXk8e1xuICB1cmk6IHN0cmluZ1xuICBsaW5lOiBudW1iZXJcbiAgY29sdW1uOiBudW1iZXJcbn0+XG5sZXQgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbmxldCBhY3RpdmUgPSBmYWxzZVxuXG5hc3luYyBmdW5jdGlvbiBzaG93TGlzdChlZGl0b3I6IFRleHRFZGl0b3IsIHRhZ3M6IFN5bVJlY1tdKSB7XG4gIGNvbnN0IHRhZyA9IGF3YWl0IHNlbGVjdExpc3RWaWV3KHRhZ3MsIHRhZ3NJbnN0YW5jZS5pblByb2dyZXNzKVxuICBpZiAodGFnICE9PSB1bmRlZmluZWQpIG9wZW4oZWRpdG9yLCB0YWcpXG59XG5cbmZ1bmN0aW9uIG9wZW4oZWRpdG9yOiBUZXh0RWRpdG9yLCB0YWc6IFN5bVJlYykge1xuICAvLyBlZGl0b3IgPz0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gIGNvbnN0IGVkcCA9IGVkaXRvci5nZXRQYXRoKClcbiAgaWYgKGVkcCkge1xuICAgIHN0YWNrLnB1c2goe1xuICAgICAgdXJpOiBlZHAsXG4gICAgICBsaW5lOiBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldEJ1ZmZlclJvdygpLFxuICAgICAgY29sdW1uOiBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldEJ1ZmZlckNvbHVtbigpLFxuICAgIH0pXG4gIH1cbiAgdm9pZCBhdG9tLndvcmtzcGFjZS5vcGVuKHRhZy51cmksIHtcbiAgICBpbml0aWFsTGluZTogdGFnLmxpbmUsXG4gICAgc2VhcmNoQWxsUGFuZXM6IHRydWUsXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgYWN0aXZlID0gdHJ1ZVxuICBzdGFjayA9IFtdXG4gIHRhZ3NJbnN0YW5jZSA9IG5ldyBUYWdzKClcbiAgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIGRpc3Bvc2FibGVzLmFkZChhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCB7XG4gICAgJ2lkZS1oYXNrZWxsLWhhc2t0YWdzOnNob3ctdGFncyc6ICgpID0+IHtcbiAgICAgIGlmICghYWN0aXZlKSByZXR1cm5cbiAgICAgIGNvbnN0IGVkID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gICAgICBpZiAoZWQpIHZvaWQgc2hvd0xpc3QoZWQsIHRhZ3NJbnN0YW5jZS5saXN0VGFncygpKVxuICAgIH0sXG4gICAgJ2lkZS1oYXNrZWxsLWhhc2t0YWdzOmdvLWJhY2snOiAoKSA9PiB7XG4gICAgICBjb25zdCBwcmV2cG9zID0gc3RhY2sucG9wKClcbiAgICAgIGlmIChwcmV2cG9zKSB7XG4gICAgICAgIHZvaWQgYXRvbS53b3Jrc3BhY2Uub3BlbihwcmV2cG9zLnVyaSwge1xuICAgICAgICAgIGluaXRpYWxMaW5lOiBwcmV2cG9zLmxpbmUsXG4gICAgICAgICAgaW5pdGlhbENvbHVtbjogcHJldnBvcy5jb2x1bW4sXG4gICAgICAgICAgc2VhcmNoQWxsUGFuZXM6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSxcbiAgfSkpXG4gIGRpc3Bvc2FibGVzLmFkZChhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcicsIHtcbiAgICAnaWRlLWhhc2tlbGwtaGFza3RhZ3M6c2hvdy1maWxlLXRhZ3MnOiAoeyBjdXJyZW50VGFyZ2V0IH0pID0+IHtcbiAgICAgIGlmICghYWN0aXZlKSByZXR1cm5cbiAgICAgIGNvbnN0IGVkaXRvcjogVGV4dEVkaXRvciA9IChjdXJyZW50VGFyZ2V0IGFzIGFueSkuZ2V0TW9kZWwoKVxuICAgICAgY29uc3QgcGF0aCA9IGVkaXRvci5nZXRQYXRoKClcbiAgICAgIGlmICghcGF0aCkgcmV0dXJuXG4gICAgICB2b2lkIHNob3dMaXN0KGVkaXRvciwgdGFnc0luc3RhbmNlLmxpc3RUYWdzKHBhdGgpKVxuICAgIH0sXG4gIH0pKVxuICBkaXNwb3NhYmxlcy5hZGQoYXRvbS5jb250ZXh0TWVudS5hZGQoe1xuICAgICdhdG9tLXRleHQtZWRpdG9yW2RhdGEtZ3JhbW1hcn49XCJoYXNrZWxsXCJdJzogW3tcbiAgICAgIGxhYmVsOiAnU2hvdyBGaWxlIFRhZ3MnLFxuICAgICAgY29tbWFuZDogJ2lkZS1oYXNrZWxsLWhhc2t0YWdzOnNob3ctZmlsZS10YWdzJyxcbiAgICB9XSxcbiAgfSkpXG4gIGRpc3Bvc2FibGVzLmFkZChhdG9tLm1lbnUuYWRkKFt7XG4gICAgbGFiZWw6ICdIYXNrZWxsIElERScsXG4gICAgc3VibWVudTogW3tcbiAgICAgIGxhYmVsOiAnSGFza3RhZ3MnLFxuICAgICAgc3VibWVudTogW3tcbiAgICAgICAgbGFiZWw6ICdTaG93IFRhZ3MnLFxuICAgICAgICBjb21tYW5kOiAnaWRlLWhhc2tlbGwtaGFza3RhZ3M6c2hvdy10YWdzJyxcbiAgICAgIH0sIHtcbiAgICAgICAgbGFiZWw6ICdTaG93IEZpbGUgVGFncycsXG4gICAgICAgIGNvbW1hbmQ6ICdpZGUtaGFza2VsbC1oYXNrdGFnczpzaG93LWZpbGUtdGFncycsXG4gICAgICB9XSxcbiAgICB9XSxcbiAgfV0pKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29uc3VtZVVQSShyZWdpc3RlcjogSVVQSVJlZ2lzdHJhdGlvbikge1xuICBjb25zdCB1cGkgPSByZWdpc3Rlcih7XG4gICAgbmFtZTogJ2lkZS1oYXNrZWxsLWhhc2t0YWdzJyxcbiAgfSlcbiAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gIGRpc3AuYWRkKHVwaSlcblxuICBkaXNwLmFkZChhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcicsIHtcbiAgICAnaWRlLWhhc2tlbGwtaGFza3RhZ3M6Z28tdG8tZGVjbGFyYXRpb24nOiAoeyBjdXJyZW50VGFyZ2V0LCBkZXRhaWwgfSkgPT4ge1xuICAgICAgaWYgKCFhY3RpdmUpIHJldHVyblxuICAgICAgY29uc3QgZWRpdG9yOiBUZXh0RWRpdG9yID0gKGN1cnJlbnRUYXJnZXQgYXMgYW55KS5nZXRNb2RlbCgpXG4gICAgICBjb25zdCBidWZmZXIgPSBlZGl0b3IuZ2V0QnVmZmVyKClcbiAgICAgIGNvbnN0IGVyID0gdXBpLmdldEV2ZW50UmFuZ2UoZWRpdG9yLCBkZXRhaWwpXG4gICAgICBpZiAoIWVyKSByZXR1cm5cbiAgICAgIGNvbnN0IHsgY3JhbmdlIH0gPSBlclxuICAgICAgY29uc3QgeyBzdGFydCwgZW5kIH0gPSBidWZmZXIucmFuZ2VGb3JSb3coY3JhbmdlLnN0YXJ0LnJvdywgZmFsc2UpXG4gICAgICBjb25zdCBjcmFuZ2UyID0geyBzdGFydDogY3JhbmdlLnN0YXJ0LCBlbmQ6IGNyYW5nZS5lbmQgfVxuICAgICAgY29uc3QgbGVmdCA9IGJ1ZmZlci5nZXRUZXh0SW5SYW5nZShbc3RhcnQsIGNyYW5nZS5zdGFydF0pXG4gICAgICBjcmFuZ2UyLnN0YXJ0LmNvbHVtbiA9IGxlZnQuc2VhcmNoKC9bXFx3J10qJC8pXG4gICAgICBjb25zdCByaWdodCA9IGJ1ZmZlci5nZXRUZXh0SW5SYW5nZShbY3JhbmdlLmVuZCwgZW5kXSlcbiAgICAgIGNyYW5nZTIuZW5kLmNvbHVtbiArPSByaWdodC5zZWFyY2goL1teXFx3J118JC8pXG4gICAgICBjb25zdCBzeW1ib2wgPSBidWZmZXIuZ2V0VGV4dEluUmFuZ2UoY3JhbmdlMilcbiAgICAgIGNvbnN0IHRhZ3MgPSB0YWdzSW5zdGFuY2UuZmluZFRhZyhzeW1ib2wpXG4gICAgICBzd2l0Y2ggKHRhZ3MubGVuZ3RoKSB7XG4gICAgICAgIGNhc2UgMDogcmV0dXJuXG4gICAgICAgIGNhc2UgMTogdm9pZCBvcGVuKGVkaXRvciwgdGFnc1swXSk7IGJyZWFrXG4gICAgICAgIGRlZmF1bHQ6IHZvaWQgc2hvd0xpc3QoZWRpdG9yLCB0YWdzKVxuICAgICAgfVxuICAgIH0sXG4gIH0pKVxuXG4gIGRpc3AuYWRkKGF0b20uY29udGV4dE1lbnUuYWRkKHtcbiAgICAnYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXJ+PVwiaGFza2VsbFwiXSc6IFt7XG4gICAgICBsYWJlbDogJ0dvIHRvIERlY2xhcmF0aW9uJyxcbiAgICAgIGNvbW1hbmQ6ICdpZGUtaGFza2VsbC1oYXNrdGFnczpnby10by1kZWNsYXJhdGlvbicsXG4gICAgfV0sXG4gIH0pKVxuXG4gIHJldHVybiBkaXNwXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlKCkge1xuICBkaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgdGFnc0luc3RhbmNlLmRlc3Ryb3koKVxuICBhY3RpdmUgPSBmYWxzZVxufVxuIl19